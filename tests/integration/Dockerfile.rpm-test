# Docker test environment for RPM scriptlets testing
FROM registry.access.redhat.com/ubi9/ubi

# Install required packages including systemd for testing
RUN dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
RUN dnf install -y make rpm-build python3-build python3-pip python-unversioned-command systemd

# Copy source files
COPY scripts /app/scripts
COPY configuration /app/configuration
COPY postprocessing /app/postprocessing
COPY pyproject.toml /app/
COPY rpmbuild.sh /app/
COPY README.md /app/
COPY LICENSE.rst /app/
COPY SPECS /app/SPECS
COPY systemd /app/systemd
COPY tests /app/tests

RUN mkdir -p /root/rpmbuild/SOURCES

# Create required users and groups for testing
RUN useradd snsdata
RUN getent group users || groupadd users
RUN getent group hfiradmin || groupadd hfiradmin

# Build the RPM
RUN cd /app && ./rpmbuild.sh || exit 1

# Copy test dependencies
COPY tests/integration/python3-pyoncat-2.1-1.noarch.rpm /root/rpmbuild/SOURCES/
RUN dnf install -y /root/rpmbuild/SOURCES/python3-pyoncat-2.1-1.noarch.rpm || exit 1

# Set up systemd in container (limited functionality)
RUN systemctl set-default multi-user.target

# Make test script executable
RUN chmod +x /app/tests/integration/test_rpm_scriptlets.sh

# Set working directory
WORKDIR /app

# Default command runs the RPM scriptlets test
CMD ["/app/tests/integration/test_rpm_scriptlets.sh"]
